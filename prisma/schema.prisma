// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//User
model User {
  id                   String                 @id @default(uuid())
  firstName            String?                @map("first_name")
  lastName             String?                @map("last_name")
  email                String                 @unique
  username             String                 @unique
  avatar               String?
  password             String?
  country              String?
  mailVerified         Boolean                @default(false) @map("mail_verified")
  twoFactorAuth        Boolean                @default(false) @map("two_factor_auth")
  is42User             Boolean                @map("is_42_user")
  status               UserStatus
  logs                 Logs?
  LeftFriendship       Friendship[]           @relation("left")
  RightFriendship      Friendship[]           @relation("right")
  User                 Game[]                 @relation("user")
  Opponnent            Game[]                 @relation("opponent")
  HaveAchievement      haveAchievement[]
  RoomChatConversation RoomChatConversation[]
  Sent                 Conversation[]         @relation("sender")
  Received             Conversation[]         @relation("receiver")
  SentNotif            Notification[]         @relation("sent")
  ReceivedNotif        Notification[]         @relation("received")

  @@map("user")
}

model Logs {
  id        String @id @default(uuid())
  victories Int
  defeats   Int
  level     Float
  rank      Rank   @default(VETERAN)
  User      User   @relation(fields: [userId], references: [id])
  userId    String @unique @map("user_id")

  @@map("logs")
}

model Friendship {
  leftUserId  String           @map("left")
  rightUserId String           @map("right")
  status      FriendshipStatus
  sender      String
  blocker     String?

  leftUser  User @relation("left", fields: [leftUserId], references: [id])
  rightUser User @relation("right", fields: [rightUserId], references: [id])

  @@id([leftUserId, rightUserId])
  @@map("friendship")
}

//Game

model Game {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  opponentId String
  map        String
  startedAt  DateTime @default(now()) @map("started_at")

  opponent User     @relation("opponent", fields: [opponentId], references: [id])
  user     User     @relation("user", fields: [userId], references: [id])
  History  History?
  accepted Boolean

  @@map("game")
}

model History {
  id            String @id @default(uuid())
  userScore     Int    @map("user_score")
  opponentScore Int    @map("opponent_score")
  userId        String @map("user_id")
  opponentId    String @map("opponent_id")

  Game   Game   @relation(fields: [gameId], references: [id])
  gameId String @unique

  @@map("history")
}

//Achievements
model Achievement {
  id              String            @id @default(uuid())
  name            String
  description     String
  HaveAchievement haveAchievement[]

  @@map("achievement")
}

model haveAchievement {
  id            String      @id @default(uuid())
  userId        String      @map("user_id")
  achievementId String      @map("achievement_id")
  level         Int
  achieved      Boolean     @default(false)
  User          User        @relation(fields: [userId], references: [id])
  Achiement     Achievement @relation(fields: [achievementId], references: [id])

  @@map("have_achievement")
}

//Chat
model RoomChat {
  id                   String                 @id @default(uuid())
  type                 RoomType
  password             String?
  RoomChatConversation RoomChatConversation[]

  @@map("room_chat")
}

model RoomChatConversation {
  id         String          @id @default(uuid())
  roomChatId String          @map("room_chat_id")
  userId     String          @map("user_id")
  userStatus UserStatusGroup @map("user_status")
  userRole   UserRole

  User     User      @relation(fields: [userId], references: [id])
  RoomChat RoomChat  @relation(fields: [roomChatId], references: [id])
  Message  Message[]

  @@map("room_chat_conversation")
}

model Message {
  id       String @id @default(uuid())
  message  String
  senderId String @map("sender_id")

  RoomChatConversation   RoomChatConversation @relation(fields: [roomChatConversationId], references: [id])
  roomChatConversationId String               @map("room_chat_conversation_id")
  Conversation           Conversation         @relation(fields: [conversationId], references: [id])
  conversationId         String               @map("conversation_id")

  @@map("message")
}

model Conversation {
  id         String @id @default(uuid())
  senderId   String @map("sender_id")
  receiverId String @map("reciever_id")

  Sender   User      @relation("sender", fields: [senderId], references: [id])
  Receiver User      @relation("receiver", fields: [receiverId], references: [id])
  Messages Message[]

  @@map("conversation")
}

//Notification 

model Notification {
  id        String    @id @default(uuid())
  notifType NotifType
  sender    User      @relation("sent", fields: [senderId], references: [id])
  receiver  User      @relation("received", fields: [receiverId], references: [id])

  senderId   String @map("sender_id")
  receiverId String @map("receiver_id")
}

//Types
enum UserStatus {
  ONLINE
  OFFLINE
  INGAME

  @@map("user_status")
}

enum UserStatusGroup {
  MUTED
  BANNED

  @@map("user_status_group")
}

enum RoomType {
  PUBLIC
  PRIVATE
  PROTECTED

  @@map("room_type")
}

enum UserRole {
  BASIC
  ADMIN

  @@map("user_role")
}

enum NotifType {
  MESSAGE
  GAME_REQUEST
  FRIEND_REQUEST

  @@map("notif_type")
}

enum FriendshipStatus {
  PENDING
  ACCEPTED
  BLOCKED
  NOT_FOUND

  @@map("friendship_status")
}

enum Mode {
  ON_TIME
  DEFI

  @@map("mode")
}

enum Map {
  NORMAL
  HARD
  EXPERT

  @@map("map")
}

enum Rank {
  VETERAN
  ELITE
  PRO
  MASTER
  GRANDMASTER

  @@map("rank")
}

enum Sender {
  LEFT_USER
  RIGHT_USER

  @@map("sender")
}
